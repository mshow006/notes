## 第4章 基于 TCP 的服务器端/客户端（1）

### 4.1 理解 TCP 和 UDP

根据数据传输方式的不同，基于网络协议的套接字分为TCP套接字和UDP套接字

TCP套接字是面向连接的，也称为基于流（stream）的套接字

TCP（Transmission Control Protocol）传输控制协议

#### TCP/IP 协议栈

![image-20210305101036823](https://i.loli.net/2021/03/05/nqjhB1r2KGpg5P8.png)

TCP/IP协议栈共4层，也就是数据收发分为4个层次化过程

通过TCP套接字收发数据：应用层 - TCP层 - IP层 - 链路层

通过UDP套接字收发数据：应用层 - UDP层 - IP层 - 链路层

> OSI 7层模型

#### 链路层 

物理链接领域标准化的结果

定义 LAN、WAN、MAN等网络标准

两台主机通过网络进行数据交换，所需的物理链接如图

![image-20210305101741916](https://i.loli.net/2021/03/05/YvkKPNZ9WV4nweO.png)

#### IP 层

准备好物理链接后就要传输数据

首先考虑路径，需要经过哪些路径到达目标就是IP层解决的

IP本身是面向消息的，不可靠协议

每次传输数据时可能会选择不一样的路径，如果传输过程中发生错误，则选择其他路径

如果数据丢失或错误，则无法解决

即 **IP 协议无法应对数据错误**

IP层只关注1个数据包（数据传输的基本单位）的传输过程

每个数据包的传输顺序是不可靠的

只利用IP层，则会有后传数据包先到达目标的情况，甚至数据包丢失或者损坏

#### TCP/UDP层

以IP层的路径信息为基础完成实际的数据传输，该层又称传输层（Transport）

发送数据时以IP层为基础（协议栈结构）

TCP 可以保证可靠的数据传输

TCP可以再数据传输过程中确认对方是否已接受数据，如果没有则重传数据

TCP协议赋予了IP协议的可靠性

#### 应用层

套接字属于应用层

### 4.2 实现基于TCP的服务器/客户端

#### TCP服务器端的默认函数调用顺序

- socket() 创建套接字
- bind()分配套接字地址
- listen()等待连接请求状态
- accept()允许连接
- read()/write()数据交换
- close()断开连接

#### listen() 等待连接请求状态

```c
#include <sys/socket.h>

// sock: 希望进入等待请求状态的套接字文件描述符，传递的描述符套接字参数成为服务器端套接字（监听套接字）
// backlog: 连接请求等待队列（Queue）的长度，最多可以有多少连接请求进入队列
// 成功返回0，失败返回-1
int listen(int sock, int backlog);
```

#### 受理客户端连接请求





